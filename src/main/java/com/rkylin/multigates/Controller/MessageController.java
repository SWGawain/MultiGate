package com.rkylin.multigates.Controller;

import com.allinpay.XmlTools;
import com.google.common.base.Strings;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;

/**
 * Created by 嘉玮 on 2015-12-4.
 */
@Controller
@RequestMapping("/msg")
public class MessageController {

    @RequestMapping(value = "/send",produces = "text/html;charset=utf-8")
    @ResponseBody
    public String sendMsg(String url,String gwNo) throws Exception {

        String reqMsg = "";
        String respMsg = "";

        System.out.println(url + " _ " + gwNo);
        if(Strings.isNullOrEmpty(url) || Strings.isNullOrEmpty(gwNo)){
            return "No params detected.";
        }

        if(gwNo.length() != 24){
            return "GateWayNo not supported.";
        }

        String xmlB= "60%63%120%109%108%32%118%101%114%115%105%111%110%61%34%49%46%48%34%32%101%110%99%111%100%105%110%103%61%34%71%66%75%34%63%62%10%60%65%73%80%71%62%10%32%32%60%73%78%70%79%62%10%32%32%32%32%60%84%82%88%95%67%79%68%69%62%50%48%48%48%48%51%60%47%84%82%88%95%67%79%68%69%62%10%32%32%32%32%60%86%69%82%83%73%79%78%62%48%51%60%47%86%69%82%83%73%79%78%62%10%32%32%32%32%60%68%65%84%65%95%84%89%80%69%62%50%60%47%68%65%84%65%95%84%89%80%69%62%10%32%32%32%32%60%82%69%81%95%83%78%62%49%52%51%55%50%54%49%53%55%53%53%53%50%60%47%82%69%81%95%83%78%62%10%32%32%32%32%60%83%73%71%78%69%68%95%77%83%71%62%53%48%51%48%97%57%98%97%52%54%49%56%50%49%99%98%57%99%51%48%53%99%53%102%57%54%102%54%56%101%53%99%101%55%98%48%51%50%55%49%102%101%102%101%55%57%56%100%48%54%55%48%51%102%53%54%49%98%100%102%57%99%57%100%56%98%57%53%99%49%50%57%54%54%101%100%50%55%54%53%55%54%98%48%52%99%100%97%52%98%54%49%100%97%98%54%102%102%57%55%53%57%98%53%98%57%97%49%50%98%49%54%101%101%102%55%48%98%50%50%48%49%50%51%102%50%98%54%102%57%48%99%97%54%102%48%100%48%57%49%52%49%97%99%99%52%102%49%51%51%57%100%50%98%101%57%55%97%101%98%99%98%54%57%98%51%101%51%97%102%50%50%100%54%56%48%51%56%54%55%48%56%97%51%51%57%53%57%98%51%98%99%98%48%57%98%56%55%53%55%101%55%54%52%99%48%55%57%56%102%53%55%101%51%99%98%102%97%52%49%54%54%102%54%102%97%99%101%102%101%55%56%102%55%56%55%98%53%48%100%53%53%48%100%53%53%100%98%101%101%56%57%52%102%54%99%101%55%99%53%50%50%52%52%102%102%52%57%99%53%49%98%50%102%51%56%100%55%50%102%56%56%99%98%53%101%99%52%97%100%48%51%100%101%48%97%55%55%102%49%102%101%53%55%53%97%97%54%97%51%56%97%54%100%52%98%51%97%52%49%99%55%97%49%57%100%57%52%101%101%100%50%51%102%52%49%97%51%49%48%97%54%48%98%50%54%53%99%49%57%56%48%50%54%50%57%99%55%101%99%97%52%100%101%56%55%52%101%53%54%48%50%57%50%56%100%55%98%49%51%1"+
                "00%54%50%50%50%48%51%98%98%52%97%98%53%101%51%98%56%54%102%55%98%52%52%54%99%53%102%56%51%55%98%99%49%53%55%49%98%49%48%101%49%57%53%57%52%53%50%51%54%57%55%55%57%97%99%51%49%52%49%53%102%57%102%99%53%100%48%57%54%51%97%53%53%49%52%97%50%53%98%49%54%98%49%52%48%99%48%51%52%53%99%54%101%54%55%49%97%99%53%53%97%56%56%49%54%97%101%55%101%51%54%100%98%53%101%48%51%56%48%52%50%100%54%48%55%97%55%48%56%50%102%99%60%47%83%73%71%78%69%68%95%77%83%71%62%10%32%32%60%47%73%78%70%79%62%10%32%32%60%78%79%84%73%70%89%62%10%32%32%32%32%60%78%79%84%73%70%89%95%83%78%62%48%48%49%49%54%55%54%52%53%51%50%56%55%48%54%49%60%47%78%79%84%73%70%89%95%83%78%62%10%32%32%60%47%78%79%84%73%70%89%62%10%60%47%65%73%80%71%62%";

        String[] split = xmlB.split("%");
        byte[] bytes = new byte[split.length];
        for (int i = 0; i < bytes.length; i++) {
            bytes[i] = Byte.valueOf(split[i]);
        }
        try {
            reqMsg = new String(bytes).replace("0011676453287061", gwNo);

            System.out.println(reqMsg);
            respMsg = XmlTools.send(url, reqMsg);
            System.out.println(respMsg);

        } catch (Exception e) {
            e.printStackTrace();
            return "Message send failed , please check background logs";
        }

        return "Message send success!";
    }
}
